---
title: "Preprocess H5AD files"
subtitle: 'Save pseudobulk, etc'
author: "Developed by [Gabriel Hoffman](http://gabrielhoffman.github.io/)"
date: "Run on `r Sys.time()`"
output: 
  html_document:
    toc: true
    smart: true
params:
  DATASET: NULL
---


<!--- 

cd /sc/arion/projects/CommonMind/hoffman/NPS-AD/work/nps_ad/analysis/freeze2/preprocess/
ml python git pandoc
git pull origin master
R --vanilla

# system("git pull origin master"); rmarkdown::render("preprocess.Rmd");


library(rmarkdown)
library(tidyverse)

h5ad_files = c(
RUSH = "/sc/arion/projects/psychAD/NPS-AD/freeze2_rc/h5ad_final/RUSH_2023-02-07_14_21.h5ad", 
HBCC = "/sc/arion/projects/psychAD/NPS-AD/freeze2_rc/h5ad_final/HBCC_2023-02-07_14_53.h5ad",
# MSSM = "/sc/arion/projects/psychAD/NPS-AD/freeze2_rc/h5ad_final/",
# FULL = "/sc/arion/projects/psychAD/NPS-AD/freeze2_rc/h5ad_final/",
AGING = "/sc/arion/projects/psychAD/NPS-AD/freeze2_rc/h5ad_final/AGING_2023-02-07_18_16.h5ad")

run = function(){
system("git pull origin master");

names(h5ad_files)[1] %>% 
  walk(function(x) render("preprocess.Rmd",
          params = list(DATASET = h5ad_files[x]),
          output_file = paste0("./preprocess_", x, ".html")))
}




# https://hoffmg01.hpc.mssm.edu/nps_ad/analysis/freeze2/preprocess/

--->


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  dev = c("png", "pdf"),
  package.startup.message = FALSE,
  cache = TRUE,
  cache.lazy = FALSE)
```

 <font size="5">__Evaluating dataset: `r names(params$DATASET)`__</font>



# Load libraries
```{r load.packages, cache=FALSE}
suppressPackageStartupMessages({
library(SingleCellExperiment)
library(zellkonverter)
library(dreamlet)
library(zenith)
library(DelayedArray)
library(GSEABase)
library(scater)
library(tidyverse)
library(scattermore)
})

# update block size for reading h5ad file from disk
setAutoBlockSize(1e9)
```

# Load data
```{r load.data}
sce = readH5AD(params$DATASET, use_hdf5=TRUE, verbose=TRUE)
assayNames(sce)[1] = "counts"

# order of cell types used for plotting
ctorder = c('EN_L2_3_IT', 'EN_L3_5_IT_1', 'EN_L3_5_IT_2', 'EN_L3_5_IT_3', 'EN_L5_IT', 'EN_L5_6_NP', 'EN_L6_CT', 'EN_L6_IT', 'EN_NF', 'IN_ADARB2', 'IN_LAMP5', 'IN_PVALB', 'IN_PVALB_CHC', 'IN_SST', 'IN_VIP', 'Oligo', 'OPC', 'Astro', 'Micro_PVM', 'CD8_T', 'PC', 'VLMC','Endo', "Immune")
```


# Summarizing data
## UMAP
```{r umap}
plotProjection(sce, "X_umap", "subclass", order=ctorder)  + ggtitle("subclass")
```
