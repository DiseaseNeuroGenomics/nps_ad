
--
title: "Gene expression of XIST/UTY"
subtitle: 'For concordance analysis'
author: "Developed by [Gabriel Hoffman](http://gabrielhoffman.github.io/)"
date: "Run on `r Sys.time()`"
documentclass: article
output: 
  html_document:
  toc: true
  smart: false
---


<!--- 

cd /sc/arion/projects/CommonMind/hoffman/NPS-AD/work/nps_ad/freeze_v2
ml python git
git pull
R --vanilla

system("git pull"); rmarkdown::render("get_sex_expression.Rmd");


# https://hoffmg01.u.hpc.mssm.edu/eval_methods/dreamlet/mathys_Nature_2019.html

--->



```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  dev = c("png", "pdf"),
  package.startup.message = FALSE,
  cache = TRUE,
  cache.lazy = FALSE)
```

```{r load.packages, cache=FALSE}
# Use cache=FALSE so that package are fully loaded each time
# This ensures that forks within mclapply() have these loaded
# Othewise, mclapply() not have access to these libraries and will fail 
#   unless the libraries are manually loaded within each fork
library(SingleCellExperiment)
library(zellkonverter)
library(DelayedArray)
library(dreamlet)
library(scater)
library(tidyverse)

setAutoBlockSize(1e9)
```

```{r read.files, eval=FALSE}
# Combine H5AD's into one SCE, them copute pseudobulk

folder = "/sc/arion/projects/psychAD/NPS-AD/freeze2_rc/h5ad-by-donor/"

files = dir(folder, pattern="*.h5ad", full.names=TRUE)

sceList = lapply(files, function(file){
  sce = readH5AD(file, use_hdf5=TRUE)
  colnames(sce) = paste0(sce$SubID_cs[1], "_", colnames(sce))
  sce
})

# get shared genes
genes = Reduce(intersect, lapply(sceList, rownames))

# Create SCE using only shared genes
sce = do.call(cbind, lapply(sceList[1:5], function(x) x[genes,]))

# Create pseudobulk
sce$constant = "counts"
sce$id = paste0(sce$SubID_cs, "_", sce$rep)

pb = aggregateToPseudoBulk(sce,
  assay = "X",     
  cluster_id = "constant",  
  sample_id = "id",
  verbose = TRUE)

# normalize gene expression
pb <- computeLibraryFactors(pb)
pb <- logNormCounts(pb)
```



```{r read.files.v2}
# Evaluate pseudobulk on each H5AD
folder = "/sc/arion/projects/psychAD/NPS-AD/freeze2_rc/h5ad-by-donor/"

files = dir(folder, pattern="*.h5ad", full.names=TRUE)

pbList = lapply(files, function(file){

  message( match(file, files))
  sce = readH5AD(file, use_hdf5=TRUE)
    
  sce$constant = "counts"
  sce$id = paste0(sce$SubID_cs, "_", sce$rep)

  pb = aggregateToPseudoBulk(sce,
    assay = "X",     
    cluster_id = "constant",  
    sample_id = "id",
    verbose=FALSE)

  # normalize gene expression
  pb <- computeLibraryFactors(pb)
  pb <- logNormCounts(pb)

  pb
})

# colData must have same columns
cols = lapply(pbList, function(x) colnames(colData(x)))
cols = Reduce(intersect, cols)

genes = c("ENSG00000183878_index", "ENSG00000229807_index")
pb = do.call(cbind, lapply(pbList, function(x){
  x = x[genes,]
  colData(x) = colData(x)[,cols]
  x
  }))
```







# plot Sex
```{r gene.expr, cache=FALSE}
df_sex = data.frame(SubID = pb$SubID_cs,
                    rep = pb$rep,
                    batch = pb$batch,
                    UTY = logcounts(pb)["ENSG00000183878_index",], 
                    XIST = logcounts(pb)["ENSG00000229807_index",])

file = "/sc/arion/projects/CommonMind/hoffman/NPS-AD/work/nps_ad/freeze_v2/sex_chr_expr.tsv"
write.table(df_sex, file, sep="\t", quote=FALSE)

ggplot(df_sex, aes(XIST, UTY)) + 
    geom_point() + 
    theme_classic() + 
    theme(aspect.ratio=1)
```



```{r clustering}
library(mclust)

fit = Mclust( data.frame(df_sex$UTY, df_sex$XIST), G=2)

ggplot(df_sex, aes(XIST, UTY, color=fit$z[,1])) + 
    geom_point() + 
    theme_classic() + 
    scale_color_gradient("Male probability", low="red", high="blue") +
    theme(aspect.ratio=1)
```

```{r compare, reps}
df = merge(df_sex[df_sex$rep==1,], df_sex[df_sex$rep==2,], by="SubID")

plot(df$UTY.x, df$UTY.y)
plot(df$XIST.x, df$XIST.y)
```













