---
title: "Analysis of NPS/AD"
subtitle: 'Process h5ad then dreamlet'
author: "Developed by [Gabriel Hoffman](http://gabrielhoffman.github.io/)"
date: "Run on `r Sys.time()`"
documentclass: article
output: 
  html_document:
  toc: true
  smart: false
vignette: >
  %\VignetteIndexEntry{Decorrelate}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\usepackage[utf8]{inputenc}
---


<!--- 

cd /hpc/users/hoffmg01/work/nps_ad
R
# rm -rf analysis_1_cache/

system("ml git; git pull")
rmarkdown::render("analysis_1.Rmd");

--->



```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning=FALSE,
  message=TRUE,
  error = FALSE,
  tidy = FALSE,
  dev = c("png", "pdf"),
  cache = TRUE,
  cache.lazy = FALSE)
```

```{r load.packages}
suppressPackageStartupMessages({
library(SingleCellExperiment)
library(zellkonverter)
library(DelayedArray)
library(DelayedMatrixStats)
library(dreamlet)
library(muscat)
library(cowplot)
library(zenith)
library(scater)
library(HDF5Array)
library(data.table)
})
```

```{r load.data}
# H5AD files from CellRanger
files = c(dir("/sc/arion/projects/CommonMind/leed62/NPS-AD/h5ad/r1", pattern="h5ad", full.names=TRUE, recursive=TRUE),
  dir("/sc/arion/projects/CommonMind/leed62/NPS-AD/h5ad/r2", pattern="h5ad", full.names=TRUE, recursive=TRUE),
  dir("/sc/arion/projects/CommonMind/leed62/NPS-AD/h5ad/r3", pattern="h5ad", full.names=TRUE, recursive=TRUE))

# read each H5AD file as SingleCellExperiment
sceList = lapply(files, function(file){
  readH5AD(file, "counts", use_hdf5=TRUE)
  })
# combine into single SingleCellExperiment
# sceCombine = do.call(cbind, sceList)
```

```{r preprocess}
# computeLibraryFactors
sceList = mclapply(sceList, function(sce){
  library(HDF5Array)

  computeLibraryFactors(sce)
}, mc.cores=24)

# perCellQCMetrics
df_qc = mclapply(sceList, function(sce){

  library(HDF5Array)

  perCellQCMetrics(sce)
}, mc.cores=24)
df_qc = do.call(rbind, df_qc)
```

# Combine with metadata
## pegasus with --min-genes 500 --max-genes 6000 --min-umis 500
## eliminates some cells
```{r cellAssigments}
file = "/sc/arion/projects/CommonMind/leed62/NPS-AD/h5ad/meta/NPS-AD_roundMerged_meta.csv"
df_cell = fread(file)
colnames(df_cell)[1] = "cellID"

sceList_filter = sapply(sceList, function(sce){

  # keep only cells in metadata
  sce = sce[,colnames(sce) %in% df_cell$cellID]

  # merge metadata
  df = merge(colData(sce), df_cell, by.x="row.names", by.y="cellID", all.x=TRUE)
  rownames(df) = df$Row.names

  # set colData
  drop = c("Row.names", "UMAP_1", "UMAP_2")
  colData(sce) = df[, !(colnames(df) %in% drop)]

  # assign UMAP
  df_umap = data.frame(UMAP1 = df$UMAP_1, UMAP2 = df$UMAP_2)
  rownames(df_umap) = df$Row.names
  reducedDims(sce) <- list(UMAP=df_umap)

  # filter based on QC
  keep = with(colData(sce), !pred_dbl & demux_type == 'singlet' & passed_qc)
  sce[,keep]
  })
```


```{r combineData, eval=FALSE}
sce$id <- paste0(sce$stim, sce$ind)
sce <- prepSCE(sce, 
    kid = "cell", # subpopulation assignments
    gid = "stim",  # group IDs (ctrl/stim)
    sid = "id",   # sample IDs (ctrl/stim.1234)
    drop = TRUE)

pb <- aggregateData(sce,
    assay = "counts", fun = "sum",
    by = c("cluster_id", "sample_id"))

# one sheet per subpopulation
assayNames(pb)
```























