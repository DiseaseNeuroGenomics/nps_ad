---
title: "snRNA-seq eQTL with mashr"
subtitle: "Plots from Biao's analysis"
author: "Developed by [Gabriel Hoffman](http://gabrielhoffman.github.io/)"
date: "Run on `r Sys.time()`"
documentclass: article
output: 
  html_document:
  toc: true
  smart: false
vignette: >
  %\VignetteIndexEntry{Decorrelate}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\usepackage[utf8]{inputenc}
---


<!--- 

cd /sc/arion/projects/CommonMind/hoffman/NPS-AD/work/nps_ad/
ml python git
git pull
# rm -rf analysis_freeze1_cache/ analysis_freeze1_files
R --vanilla

system("git pull")
rmarkdown::render("mashr.Rmd");


# https://hoffmg01.u.hpc.mssm.edu/nps_ad/

--->

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  dev = c("png", "pdf"),
  package.startup.message = FALSE,
  cache = TRUE,
  cache.lazy = FALSE)
```

```{r load.data}
library(synapser)
synLogin()

load(synGet('syn26969627')$path)
```

```{r analysis}
library(mashr)
library(variancePartition)

# posterior coefficients
#   replacing missing with Na
beta.post = get_pm(m2)
beta.post[is.na(beta)] = NA

C = cor(beta, use='pairwise.complete.obs')
plotCorrMatrix( C, main="Original" )

C = cor(beta.post, use='pairwise.complete.obs')
plotCorrMatrix(C, main="mashr" )

# sharing based on sigh
get_pairwise_sharing(m2, factor=0)


# pi1 values
df = get_estimated_pi(m2)
df = data.frame(Component = names(df), pi = df)

ggplot(df, aes(Component, pi)) + 
  geom_bar(stat="identity", fill="darkred") + 
  theme_classic() +
  theme(aspect.ratio=1, plot.title = element_text(hjust = 0.5)) +
  coord_flip() +
  scale_y_continuous(limits=c(0, 1), expand=c(0,0)) +
  ylab("Posterior probability") +
  ggtitle("eQTL sharing from mashr")


# Frequency
df = table(get_n_significant_conditions(m2))
df = as.data.frame(df)

ggplot(df, aes(Var1, Freq)) + 
  geom_bar(stat="identity", fill="darkred") + 
  theme_classic() +
  theme(aspect.ratio=1, plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits=c(0, NA), expand=c(0,0)) +
  ylab("Number of genes") +
  xlab("Number of cell types")  +
  ggtitle("Frequency of eQTL sharing")

# UpsetR plot
library(UpSetR)

listInput = lapply( colnames(beta.post), function(cond)
                get_significant_results(m2, conditions=cond))
names(listInput) = colnames(beta.post)

upset(fromList(listInput), order.by = "freq")
```




```{r test, eval=FALSE}
idx = which.max(get_estimated_pi(m2)) -1

m2$fitted_g$Ulist[idx]

v = apply(beta.post, 1, var)

beta[which.max(v),,drop=FALSE]
beta.post[which.max(v),,drop=FALSE]
```








