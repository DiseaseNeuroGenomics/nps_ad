---
title: "Null simulations subsets of NPS/AD"
subtitle: 'STAR-solo R1-4 merged h5ad'
author: "Developed by [Gabriel Hoffman](http://gabrielhoffman.github.io/)"
date: "Run on `r Sys.time()`"
documentclass: article
output: 
  html_document:
  toc: true
  smart: false
vignette: >
  %\VignetteIndexEntry{Decorrelate}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\usepackage[utf8]{inputenc}
---


<!--- 

# results 
# /sc/arion/projects/CommonMind/hoffman/NPS-AD/work/nps_ad/demo/results
cd /sc/arion/projects/CommonMind/hoffman/NPS-AD/work/nps_ad/
ml python git
git pull
R
# rm -rf demo_dreamlet_sims_cache

system("git pull"); rmarkdown::render("demo_dreamlet_sims.Rmd");


# https://hoffmg01.u.hpc.mssm.edu/nps_ad/demo_dreamlet_sims.html


ml git
cd ~/build2/dreamlet
git pull
R CMD INSTALL .


--->



```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  dev = c("png", "pdf"),
  cache = TRUE,
  cache.lazy = FALSE)
```

```{r load.packages, cache=FALSE}
# Use cache=FALSE so that package are fully loaded each time
# This ensures that forks within mclapply() have these loaded
# Othewise, mclapply() not have access to these libraries and will fail 
#   unless the libraries are manually loaded within each fork
suppressPackageStartupMessages({
library(SingleCellExperiment)
library(dreamlet)
library(muscat)
library(scater)
library(tidyverse)
library(ggplot2)
library(gtools)
library(DESeq2)
library(parallel)
library(edgeR)
library(lme4)
library(kableExtra)
library(RhpcBLASctl)
omp_set_num_threads(1)
})
```

```{r load.data}
# includes replicates
pb = readRDS("/sc/arion/projects/CommonMind/hoffman/NPS-AD/work/demo_dreamlet_pbobj.RDS")

# Completely collapsed
pbObj.Donor = readRDS("/sc/arion/projects/CommonMind/hoffman/NPS-AD/work/demo_dreamlet_pbobj_Donor.RDS")
pbObj.Donor$SubID = pbObj.Donor$Row.names 

# Full Data
outfolder = '/sc/arion/projects/CommonMind/hoffman/NPS-AD/work/nps_ad/demo/results/ demo_dreamlet_sce_mod.RDS'
sceFull = readRDS(outfolder)

# simulate balanced phenotype
set.seed(1)
ids_ad = c()

for( batch in levels(pb$BatchID)){

  # get Subject IDs in this batch
  ids = strsplit(batch, ',')[[1]]

  a = ids[1:ceiling(length(ids)/2)]
  # a = sample(ids, length(ids)/2)

  ids_ad = append(ids_ad, a)
}

pb$Dxsim = rep("Control", ncol(pb))
pb$Dxsim[pb$SubID %in% ids_ad] = "AD"
pb$Dxsim = factor(pb$Dxsim, c("Control", "AD"))

pbObj.Donor$Dxsim = rep("Control", ncol(pbObj.Donor))
pbObj.Donor$Dxsim[pbObj.Donor$SubID %in% ids_ad] = "AD"
pbObj.Donor$Dxsim = factor(pbObj.Donor$Dxsim, c("Control", "AD"))

sceFull$Dxsim = rep("Control", ncol(sceFull))
sceFull$Dxsim[sceFull$SubID %in% ids_ad] = "AD"
sceFull$Dxsim = factor(sceFull$Dxsim, c("Control", "AD"))

# set cohort
sceFull$cohort = c()
for(CHRT in unique(pbObj.Donor$cohort)){

  ids = pbObj.Donor$SubID[pbObj.Donor$cohort == CHRT]

  sceFull$cohort[sceFull$SubID %in% ids] = CHRT
}
```




```{r define.methods}
run_method = function(pb, formula, method){

  if( method == "dreamlet"){
    res.time = system.time({
      res.proc = processAssays( pb, ~ 1, BPPARAM=SnowParam(4), quiet=TRUE, min.samples=6) 
      fit = dreamlet( res.proc, formula, BPPARAM=SnowParam(4), quiet=TRUE)
      tab <- topTable(fit, coef='DxsimAD', number=Inf)
    })
  }else if( method == "DESeq2"){

    # filter genes and samples using dreamlet code
    res.proc = processAssays( pb, ~ 1, quiet=TRUE, min.samples=6)
  
    res.time = system.time({
    # DESeq2
    res = lapply(assayNames(res.proc), function(CT){
        
        # get included genes and samples
        tmp = assay(res.proc, CT)

        # cat(CT, dim(tmp))

        # subset based on dreamlet filter
        pb.sub = pb[rownames(tmp), colnames(tmp)]

        dds = suppressMessages(DESeqDataSetFromMatrix( assay(pb.sub, CT), colData(pb.sub), formula))
        dds = suppressMessages(DESeq(dds, quiet=TRUE))
        res = results(dds)

        data.frame(ID = rownames(res),
            cluster_id = CT,
            logFC = res$log2FoldChange,
            AveExpr = res$baseMean, 
            t = res$stat, 
            P.Value = res$pvalue, 
            p_adj.loc = p.adjust(res$pvalue, "BH"))
    })
    tab = do.call(rbind, res)
    tab$adj.P.Val = p.adjust(tab$P.Value, "BH")
    })
  }else if( method == "limma"){


  }else if( method == "edgeR"){
    
  }else if( method == "glmer"){

    # filter genes and samples using dreamlet code
    res.proc = processAssays( pb, ~ 1, quiet=TRUE, min.samples=6)

    sce = sceFull[,sceFull$SubID %in% unique(pb$SubID)]
  
    res.time = system.time({
    # DESeq2
    res = lapply(assayNames(res.proc), function(CT){
        
        # get included genes and samples
        tmp = assay(res.proc, CT)

        # cat(CT, dim(tmp))

        # subset based on dreamlet filter
        pb.sub = pb[rownames(tmp), colnames(tmp)]

        sce.CT = sce[,sce$celltype8==CT]
        df = droplevels(as.data.frame(colData(sce.CT)))

        counts = as(assay(sce.CT, "X"), "sparseMatrix")

        df$cs = colSums(counts)

        res.glmer = mclapply(rownames(pb.sub), function(gene){

          df$y = c(counts[gene,])
          form = as.formula(paste('y ~ offset(log(cs)) + ', as.character(formula)[2] ,'+ (1|SubID)'))

          fit = suppressWarnings(glmer(form, data=df, family = 'poisson'))

          data.frame(ID = gene, t(coef(summary(fit))['DxsimAD',]))
          }, mc.cores=4)
        res.glmer = do.call(rbind, res.glmer)

        data.frame(ID = res.glmer$ID,
            cluster_id = CT,
            logFC = res.glmer$Estimate,
            AveExpr = NA, 
            t = res.glmer$z.value, 
            P.Value = res.glmer$Pr...z.., 
            p_adj.loc = p.adjust(res.glmer$Pr...z.., "BH"))
    })
    tab = do.call(rbind, res)
    tab$adj.P.Val = p.adjust(tab$P.Value, "BH")
    })
    
  }

  tab$n = ncol(pb)
  tab$method = method
  tab$formula = paste(as.character(formula), collapse=' ')
  tab$time.user = res.time[1]
  tab$time.system = res.time[2]
  tab$time.elapsed = res.time[3]

  tab
}
```



```{r run.sims}
knitr::knit_exit()

n_batches = c(2, 3)#, 6, 12)#, 18, 25, 36)
methods = c('dreamlet', "DESeq2", "glmer")

resTabl = mclapply(n_batches, function(nbatch){

  idx = pbObj.Donor$BatchID %in% levels(pbObj.Donor$BatchID)[1:nbatch]

  resTabl = lapply(methods, function(method){
    message(method, ' ', nbatch )
    res1 = run_method( pbObj.Donor[,idx], ~ Dxsim + cohort, method)
    res2 = run_method( pbObj.Donor[,idx], ~ Dxsim + cohort + BatchID, method)
    if( method == "dreamlet"){      
      res3 = run_method( pbObj.Donor[,idx], ~ Dxsim + cohort + (1|BatchID), method)
    }else{
      res3 = data.frame()
    }
    smartbind(res1, res2, res3)
  })
  smartbind(list=resTabl)
}, mc.cores=6)
resTabl = do.call(rbind, resTabl)
```

```{r plot.time, cache=FALSE}
df = resTabl %>%
  as_tibble 

xmax = 1.02* max(df$n)

ggplot(df, aes(n, time.elapsed, color=paste(method, formula))) + 
    geom_line() + 
    geom_point() + 
    theme_classic() +
    theme(aspect.ratio=1, plot.title = element_text(hjust = 0.5)) + 
    scale_y_log10() + 
    scale_x_continuous(limits=c(0, xmax), expand=c(0,0)) +
    ggtitle("Run time") + 
    xlab("# Subjects") + 
    ylab("Elapsed time (s)") +
    scale_color_brewer(palette="Set1", name="Method + formula")
```


```{r plot.time.user, cache=FALSE}
df = resTabl %>%
  as_tibble 

xmax = 1.02* max(df$n)

ggplot(df, aes(n, time.elapsed, color=paste(method, formula))) + 
    geom_line() + 
    geom_point() + 
    theme_classic() +
    theme(aspect.ratio=1, plot.title = element_text(hjust = 0.5)) + 
    scale_y_log10() + 
    scale_x_continuous(limits=c(0, xmax), expand=c(0,0)) +
    ggtitle("CPU time") + 
    xlab("# Subjects") + 
    ylab("CPU time (s)") +
    scale_color_brewer(palette="Set1", name="Method + formula")
```


```{r plot.FD, cache=FALSE}
df = resTabl %>%
  as_tibble %>%
  group_by(n, method, formula) %>%
  summarize( nDE = sum(adj.P.Val < 0.05, na.rm=TRUE), total = sum(!is.na(adj.P.Val))) 
ymax = 1.02* max(df$nDE)
xmax = 1.02* max(df$n)

ggplot(df, aes(n, nDE, color=paste(method, formula))) + 
    geom_point() + 
    theme_classic() +
    theme(aspect.ratio=1, plot.title = element_text(hjust = 0.5)) + 
    scale_y_continuous(limits=c(0, ymax)) + 
    scale_x_continuous(limits=c(0, xmax), expand=c(0,0)) +
    ggtitle("False positives from simulations") + 
    xlab("# Subjects") + 
    ylab("False positive genes") +
    scale_color_brewer(palette="Set1", name="Method + formula")
```




```{r plot.FPR, cache=FALSE}
df = resTabl %>%
  as_tibble %>%
  group_by(n, method, formula) %>%
  summarize( FPR = sum(P.Value < 0.05, na.rm=TRUE) / sum(!is.na(P.Value)))

ymax = 1.02* max(df$FPR)
xmax = 1.02* max(df$n)

ggplot(df, aes(n, FPR, color=paste(method, formula))) + 
    geom_hline(yintercept = 0.05, linetype="dashed", color="grey") +
    geom_point() +
    theme_classic() +
    theme(aspect.ratio=1, plot.title = element_text(hjust = 0.5)) + 
    scale_y_continuous(limits=c(0, ymax), expand=c(0,0)) + 
    scale_x_continuous(limits=c(0, xmax), expand=c(0,0)) +
    ggtitle("False positives from simulations") + 
    xlab("# Subjects") + 
    ylab("False positive rate") +
    scale_color_brewer(palette="Set1", name="Method + formula")
```



```{r plot.FPR.bar, cache=FALSE}
df = resTabl %>%
  as_tibble %>%
  group_by(n, method, formula) %>%
  summarize( FPR = sum(P.Value < 0.05, na.rm=TRUE) / sum(!is.na(P.Value)))

ymax = 1.02* max(df$FPR)
xmax = 1.02* max(df$n)

ggplot(df, aes(as.character(n), FPR, fill=paste(method, formula))) + 
    geom_bar(stat="identity", position="dodge2") +
    geom_hline(yintercept = 0.05, linetype="dashed", color="grey") +
    theme_classic() +
    theme(aspect.ratio=1, plot.title = element_text(hjust = 0.5)) + 
    scale_y_continuous(limits=c(0, ymax), expand=c(0,0)) + 
    ggtitle("False positives from simulations") + 
    xlab("# Subjects") + 
    ylab("False positive rate") +
    scale_fill_brewer(palette="Set1", name="Method + formula")
```

















    





















