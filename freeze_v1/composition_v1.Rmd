---
title: "Analysis of NPS/AD"
subtitle: 'Compositional anaysis: freeze 1'
author: "Developed by [Gabriel Hoffman](http://gabrielhoffman.github.io/)"
date: "Run on `r Sys.time()`"
documentclass: article
output: 
  html_document:
  toc: true
  smart: false
vignette: >
  %\VignetteIndexEntry{Decorrelate}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\usepackage[utf8]{inputenc}
---


<!--- 

cd /sc/arion/projects/CommonMind/hoffman/NPS-AD/work/nps_ad/freeze_v1
ml python git
git pull
# rm -rf analysis_freeze1_cache/ analysis_freeze1_files
R --vanilla

system("git pull")
rmarkdown::render("composition_v1.Rmd");


# https://hoffmg01.u.hpc.mssm.edu/nps_ad/freeze_v1/composition_v1.html



npsad:roussoslab

--->



```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  dev = c("png", "pdf"),
  package.startup.message = FALSE,
  cache = TRUE,
  cache.lazy = FALSE)
```

```{r load.packages}
library(crumblr)
library(variancePartition)
library(dreamlet)
library(tidyverse)
library(propr)
library(kableExtra)
```


# Cell type composition
```{r load.data, eval=FALSE}
outfolder = "/sc/arion/projects/CommonMind/hoffman/NPS-AD/work/nps_ad/freeze1_results/"

# file = paste0(outfolder, 'cellCounts.RDS')
# df_cellCounts = readRDS(file)

# file = paste0(outfolder, 'colData_pb.RDS')
# info = as.data.frame(readRDS(file))

file = paste0(outfolder, 'colData_full.RDS')
infoFull = as.data.frame(readRDS(file))
```

```{r create.summary}

CT_FOCUS = 'celltype8'
# leiden_labels, anno, class, celltype, subtype, celltype8

# Compute counts of each cell type
df_cellCounts = infoFull %>% 
  group_by(across(c('Channel', CT_FOCUS))) %>%
  count() %>%
  pivot_wider(names_from=CT_FOCUS, values_from='n', values_fill=0) %>%
  column_to_rownames("Channel")

# extract subject metadata
info = infoFull %>%
  group_by(Channel) %>%
  select(Channel, SubID, round_num, HTO, batch, prep, dx, Institution, Age, Sex, Ethnicity )  %>%
  distinct %>%
  mutate(dx = relevel(dx, "Control")) %>%
  column_to_rownames("Channel") 

# same sorting
info = info[rownames(df_cellCounts),]

# compute cell fractions
fractions = t(apply(df_cellCounts, 1, function(x){
  x = x+1
  x / sum(x)
}))
```


## Plot cell type composition

Study-wide

```{r plotCellComposition.summary, fig.height=4, fig.width=6}
plotCellComposition( t(colSums(df_cellCounts)))
```

Summarized by disease status

```{r plotCellComposition, fig.height=20, fig.width=5}
tab = sort(table(info$dx))
tab = tab[tab>40]

figLst = lapply(names(tab), function(lvl){

  idx = which(info$dx == lvl)
  idx = idx[!is.na(idx)]

  fig = plotCellComposition(df_cellCounts[idx,]) + ggtitle(lvl) + theme_void()

  if( lvl != names(tab)[which.max(tab)] ){
    fig = fig + theme(legend.position="none")
  }
  fig
})
plot_grid(plotlist=figLst, rel_heights= tab, ncol=1, align="hv", axis="tblr")
```




## Partition variation in cell type composition
```{r cellTypeCompositionVarPart, fig.height=4, fig.width=6}
# keep subjects with observed data
i = with(info, !is.na(dx) & !is.na(Age) & !is.na(Sex))

# crumblr transform cell counts
cobj = crumblr(df_cellCounts[i,])

form = ~ (1|SubID) + (1|batch) + (1|round_num) + (1|HTO) + (1|Sex) + (1|dx) + (1|Institution) + scale(Age) 

# variance partitioning analysis
df_vp = fitExtractVarPartModel(cobj, form, info[i,])

colnames(df_vp) = gsub("scale\\((.*)\\)", "\\1", colnames(df_vp))
colnames(df_vp) = gsub("SubID", "Subject", colnames(df_vp))

plotPercentBars( df_vp )
```


## Perform statistical tests
For each cell type:

```{r cellTypeCompositionTest}
form = ~ (1|SubID) + (1|batch) + (1|round_num) + (1|HTO) + (1|Sex) + dx + (1|Institution) + scale(Age) 

fit = dream(cobj, form, info[i,])
fit = eBayes(fit)

coefs = c('dxAD', 'dxBP', 'dxSCZ')

topTable(fit, coef=coefs[1], number=Inf, sort.by="none")[,1:5] %>% 
  kable(digits=c(2, 2, 2, 3, 3, 2, 2), caption=coefs[1]) %>% 
  kable_classic(full_width = FALSE, html_font = "Cambria")

topTable(fit, coef=coefs[2], number=Inf, sort.by="none")[,1:5] %>%
  kable(digits=c(2, 2, 2, 3, 3, 2, 2), caption=coefs[2]) %>% 
  kable_classic(full_width = FALSE, html_font = "Cambria")

topTable(fit, coef=coefs[3], number=Inf, sort.by="none")[,1:5] %>% 
  kable(digits=c(2, 2, 2, 3, 3, 2, 2), caption=coefs[3]) %>% 
  kable_classic(full_width = FALSE, html_font = "Cambria")

topTable(fit, coef=coefs[4], number=Inf, sort.by="none")[,1:5] %>% 
  kable(digits=c(2, 2, 2, 3, 3, 2, 2), caption=coefs[3]) %>% 
  kable_classic(full_width = FALSE, html_font = "Cambria")
```

## Association between components

Compositional rho

```{r association.rho, fig.height=6, fig.width=6}
res = propr( df_cellCounts[i,] + .5, metric="rho" )

plotCorrMatrix(res@matrix, main='propr rho')
```

Correlation of CLR

```{r association.clr, fig.height=6, fig.width=6}
C1 = cor(t(cobj$E))

plotCorrMatrix(C1, main='Cor CLR')
```

Correlation of VST

```{r association.vst, fig.height=6, fig.width=6}
C2 = cor(t(vst(cobj)))

plotCorrMatrix(C2, main='Cor vst')
```


# PCA
```{r pca}
# PCA on VST
# res = prcomp( t(vst(cobj)), scale.=FALSE )
res = prcomp( t(cobj$E) )

# merge with subject metadata
df_pca = merge(as.data.frame(res$x), info[i,], by="row.names")
df_pca = merge(df_pca, fractions, by.x="Row.names", by.y="row.names")

df_pca %>%
      ggplot(aes(PC1, PC2, color=dx)) + 
        geom_point() +
        theme_classic() +
        theme(aspect.ratio=1, legend.position="right")

df = cor(df_pca[,2:3], df_pca[,c( 'Age', colnames(fractions))], method="sp")
df = data.frame(variable = colnames(df), t(df))

df %>%
  pivot_longer(cols=-"variable", names_to="PC") %>%
  ggplot(aes(PC, variable, fill=value)) +
      geom_tile() +
      theme_classic() +
      theme(aspect.ratio=5) +
      scale_fill_gradient2(name = "Correlation", low="blue", mid="white", high="red", limits=c(-1, 1))
```



```{r exit2, cache=FALSE, eval=TRUE, echo=FALSE}
knitr::knit_exit()
```




Examine effect of batch.  Check composition with age.

```{r test.composiution}
form = ~ (1|SubID)  + (1|batch)  + (1|round_num) + (1|HTO) + (1|Institution) + dx*Sex + scale(Age) 

i = with(info, (dx %in% c("AD", "Control")) & !is.na(Age) & !is.na(Sex))

# crumblr transform cell counts
cobj = crumblr(df_cellCounts)


fit = dream(cobj[,i], form, info[i,])
fit = eBayes(fit)

head(coef(fit))

topTable(fit, coef='dxAD', number=Inf, sort.by="none")
```



```{r test.composiution.plots}

# library(crumblr)
form = ~ (1|SubID) + (1|batch)  + (1|round_num) + (1|HTO) + (1|Institution) + Sex + scale(Age) 

i = with(info, (dx %in% c("Control")) & !is.na(Age) & !is.na(Sex))

# crumblr transform cell counts
cobj = crumblr(df_cellCounts)


fractions = t(apply(df_cellCounts, 1, function(x){
  x = x+1
  x / sum(x)
}))


fit = dream(cobj[,i], form, info[i,])
fit = eBayes(fit)

head(coef(fit))

topTable(fit, coef='scale(Age)', number=Inf, sort.by="none")

# fractions[i,]
# t(cobj[,i]$E)

merge(info[i,], fractions[i,], by="row.names") %>% 
  as_tibble %>% 
  group_by(SubID) %>% 
  summarize(OPC = mean(OPC),
    Age = Age[1]) %>%
  ggplot(aes(Age, OPC)) + 
    geom_point() + 
    theme_classic() + 
    theme(aspect.ratio=1) + 
    geom_smooth(method="lm")

# ggsave("test.png", fig)


x = as.data.frame(fractions[i,][order(info$Age[i]),])

tail(x)

plotPercentBars( x ) + theme(axis.text.y=element_blank())

# ggsave("test.png", fig)


merge(info[i,], fractions[i,], by="row.names") %>% 
  as_tibble  %>% 
  mutate(ord = factor(Row.names[order(Age)])) %>% 
  pivot_longer(cols=colnames(fractions), values_to="frac", names_to="CellComp") %>%ggplot(aes(ord, y=frac, fill=CellComp)) +
    geom_bar(position="stack", stat="identity")  + 
    theme(axis.text.x=element_blank())

# ggsave("test.png", fig)

library(propr)

res = propr( df_cellCounts[i,] + .5, metric="rho" )

# png("test.png")
plotCorrMatrix(res@matrix)
# dev.off()

source("../helper/flow.R")

from = c(t(x[1,]))
names(from) = colnames(x)

to = c(t(x[492,]))
names(to) = colnames(x)

D.rate = getTransitionAverages(from, to)



# Plots of data and inferred rates
plotFromToBars(from, to) + coord_flip()

# ggsave("test.png", fig)

plotFromToMatrix(D.rate) + theme(axis.text.x=element_text(angle=45, hjust=1))

# ggsave("test.png", fig)

# png("test.png")
plotFromToNetwork( D.rate )
 dev.off()
```

```{r remaCor, eval=FALSE}
tab = topTable(fit, coef=coefs[1], number=Inf, sort.by="none")
tab = tab[grep("neuron", rownames(tab)),]

library(remaCor)

se = with(tab, logFC/t)
C =  cor(t(vst(cobj)))
i = grep("neuron", rownames(C))

C[i,i]

LS( tab$logFC, se, cor=C[i,i])

RE2C( tab$logFC, se, cor=C[i,i])
```


