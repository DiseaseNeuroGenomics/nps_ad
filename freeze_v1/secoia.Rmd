---
title: 'secoia'
subtitle: '<u>S</u>ingl<u>e</u> <u>C</u>ell <u>O</u>utlier <u>I</u>dentification <u>A</u>nalysis'
author: "Developed by [Gabriel Hoffman](http://gabrielhoffman.github.io/)"
date: "Run on `r Sys.time()`"
documentclass: article
output: 
  html_document:
  toc: true
  smart: false
vignette: >
  %\VignetteIndexEntry{secoia}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\usepackage[utf8]{inputenc}
---


<!---


cd /sc/arion/projects/CommonMind/hoffman/NPS-AD/work/nps_ad/freeze_v1
ml python git
git pull

R
system("git pull"); rmarkdown::render("secoia.Rmd")

# rm -rf secoia_cache/ secoia_files/

https://hoffmg01.u.hpc.mssm.edu/nps_ad/freeze_v1/secoia.html


--->


<style>
body {
text-align: justify}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  dev = c("png", "pdf"),
  package.startup.message = FALSE,
  cache = TRUE,
  cache.lazy = FALSE)
```

```{r load}
library(scater)
library(secoia)
library(BiocParallel)
library(SingleCellExperiment)

outfolder = "/sc/arion/projects/CommonMind/hoffman/NPS-AD/work/nps_ad/freeze1.5_results/"

# sceCombine = readRDS( datafile )

# # aggregate genes on chromosomes
# sceAggr = aggregateAcrossFeatures(sceCombine, rowData(sceCombine)$gene_chrom)
 
# saveRDS(sceAggr, paste0(outfolder, "/sceAggr.RDS"))

sceAggr = readRDS(paste0(outfolder, "/sceAggr.RDS"))
```

```{r run.model}
# formula = ~ (1|SubID) + (1|batch)
formula = ~ 1

res = secoia(sceAggr, "celltype", formula, 
          BPPARAM = SnowParam(12, progressbar=TRUE), 
          includeVariables = c("AD", "Sex", "SubID"))
```



```{r plot.res}
table(res$result$fdr_down < 0.05)
table(res$result$fdr_up < 0.05)
 
qqplot(res)
```

```{r plotPercentBars, eval=FALSE}
plotPercentBars(res)
``` 

```{r plot_resid_pred}
plot_resid_pred(res)
```

```{r plot_effect_size}
plot_effect_size(res)
```

```{r plot.res2}
res2 = fitEmpiricalNull(res)
 
table(res2$result$fdr_down < 0.05)
table(res2$result$fdr_up < 0.05)

qqplot(res2)
```


```{r plot.res3}
# learn null only from AD controls
include = (res$results$AD == 0)
res3 = fitEmpiricalNull(res, include)
 
table(res3$result$fdr_down < 0.05)
table(res3$result$fdr_up < 0.05)
```

```{r qqplot3}
qqplot(res3)
```

```{r qqplot.grid}
qqplot(res3, facet_by = ~ chrom + celltype, 10, legend.position="none") + facet_grid( chrom ~ celltype ) 
```









