---
title: "Test pseudotime"
subtitle: 'Fresh Microglia and NPSAD'
author: "Developed by [Gabriel Hoffman](http://gabrielhoffman.github.io/)"
date: "Run on `r Sys.time()`"
documentclass: article
output: 
  html_document:
    toc: true
    smart: false
---


<!--- 

# cd /Users/gabrielhoffman/workspace/repos/nps_ad/mg

cd /sc/arion/projects/CommonMind/hoffman/NPS-AD/work/nps_ad/mg
R --vanilla

system("ml git; git pull"); rmarkdown::render("test_pseudotime.Rmd");


# https://hoffmg01.hpc.mssm.edu/mg/test_pseudotime.html


--->



```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  dev = c("png", "pdf"),
  package.startup.message = FALSE,
  cache = TRUE,
  cache.lazy = FALSE)
```


```{r load.packages}
library(tidyverse)
library(variancePartition)
library(lmerTest)
library(ggplot2)
library(zellkonverter)
library(SingleCellExperiment)
```

```{r analysis}
# PsychAD MicroPVM + metadata
file = "/sc/arion/projects/Microglia/scRNAseq_proc/freeze3/5_taxonomy/1_scANVI_psychAD_annotation/230420_PsychAD_MicroPVM_independent_meta_scANVI_new-umap.h5ad"
# sce = readH5AD(file, use_hdf5=TRUE, verbose=TRUE, uns=FALSE, layers=FALSE, obsm=FALSE)
# saveRDS(colData(sce), file="/sc/arion/scratch/hoffmg01/data/colData.RDS")
sce_colData = readRDS("/sc/arion/scratch/hoffmg01/data/colData.RDS")

files = dir("/sc/arion/scratch/hoffmg01/data/", recursive=TRUE, full.names=TRUE)
names(files) = gsub(".csv", "", paste(basename(dirname(files)), basename(files), sep="/"))

dfList = lapply( names(files)[1:2], function(id){

	df = read_csv(files[id])
	df$SubID =  gsub("-[GCTA]+", "", df$barcodekey)

	df
	})
names(dfList) = names(files)[1:2]

dfList2 = lapply( names(files)[3:4], function(id){

	df = read_csv(files[id])

	df = cbind(df[,1:3], sce_colData[df[["...1"]]+1,])

	df
	})
names(dfList2) = names(files)[3:4]

dfList = c(dfList, dfList2)
```

```{r plots}
fitList = lapply(names(dfList), function(id){
	message(id)
	ggplot(dfList[[id]], aes(as.character(braak), dpt_pseudotime, fill=braak)) +
	geom_violin() +
	theme_classic() +
	theme(aspect.ratio=1) +
	xlab("Braak") + 
	ggtitle(id)
})
fitList
```


```{r lmer}
res = lapply(names(dfList), function(id){

	if( grepl("fresh_mg", id) ){
		form = dpt_pseudotime ~ braak + (1|subtype) + (1|SubID)
	}else{
		form = dpt_pseudotime ~ braak + (1|subtype) + (1|SubID)
	}

	fit = lmer(form, dfList[[id]], REML=FALSE, control=lme4::lmerControl(optimizer="Nelder_Mead"))

	list(vp = calcVarPart(fit), summary = coef(summary(fit)))
})
names(res) = names(dfList)
```

```{r show.lmer}
res
```


<!---

PsychAD metadata
/sc/arion/projects/psychAD/NPS-AD/freeze2_rc/metadata/clinical_metadata.csv
/sc/arion/projects/psychAD/NPS-AD/freeze2_rc/metadata/clinical_metadata_sampleSets_latest.RDS
--->

